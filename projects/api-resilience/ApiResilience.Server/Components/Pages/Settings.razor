@page "/settings"
@using System.ComponentModel.DataAnnotations
@inject ServerSettingsService SettingsService

<PageTitle>Server Settings</PageTitle>

<h1>Server Resilience Settings</h1>
<p class="settings-description">
  Configure API resilience testing parameters. These settings control delays and errors introduced during API calls.
</p>

<div class="row">
  <div class="col-md-6 d-flex flex-column">
    <EditForm Model="@editModel" OnValidSubmit="@HandleValidSubmit" class="d-flex flex-column flex-fill">
      <DataAnnotationsValidator />
      <ValidationSummary class="validation-summary" />

      <div class="form-section flex-fill">
        <h3>Edit Settings</h3>
        
        <div class="alert alert-info">
          <strong>Note:</strong> The sum of Delay Probability and Error Probability cannot exceed 100% (1.0).
          <br />
          Current total: <strong>@((editModel.DelayProbability + editModel.ErrorProbability) * 100)%</strong>
        </div>

        <div class="form-group">
          <label for="delayProbability">Delay Probability:</label>
          <InputNumber id="delayProbability" class="form-control" @bind-Value="editModel.DelayProbability" step="0.01" />
          <small class="form-text">Probability of introducing delay (0.0-1.0 where 0.2 = 20%)</small>
          <ValidationMessage For="@(() => editModel.DelayProbability)" />
        </div>

        <div class="form-group">
          <label for="delayDuration">Delay Duration (milliseconds):</label>
          <InputNumber id="delayDuration" class="form-control" @bind-Value="editModel.DelayDurationMs" />
          <small class="form-text">Duration of delay when triggered (0-30000 ms)</small>
          <ValidationMessage For="@(() => editModel.DelayDurationMs)" />
        </div>

        <div class="form-group">
          <label for="errorProbability">Error Probability:</label>
          <InputNumber id="errorProbability" class="form-control" @bind-Value="editModel.ErrorProbability" step="0.01" />
          <small class="form-text">Probability of throwing errors (0.0-1.0 where 0.2 = 20%)</small>
          <ValidationMessage For="@(() => editModel.ErrorProbability)" />
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Apply Settings</button>
        <button type="button" class="btn btn-secondary" @onclick="ResetToDefaults">Reset to Defaults</button>
      </div>
    </EditForm>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
      <div class="alert alert-@(isSuccess ? "success" : "danger") mt-3">
        @statusMessage
      </div>
    }
  </div>
  <div class="col-md-6 d-flex flex-column">
    <div class="current-settings flex-fill">
      <h3>Current Settings</h3>
      <table class="table table-sm">
        <tbody>
          <tr>
            <td><strong>Delay Probability:</strong></td>
            <td>@(currentSettings.DelayProbability * 100)%</td>
          </tr>
          <tr>
            <td><strong>Delay Duration:</strong></td>
            <td>@currentSettings.DelayDurationMs ms</td>
          </tr>
          <tr>
            <td><strong>Error Probability:</strong></td>
            <td>@(currentSettings.ErrorProbability * 100)%</td>
          </tr>
          <tr>
            <td colspan="2" class="table-info">
              <strong>Total Probability:</strong> @((currentSettings.DelayProbability + currentSettings.ErrorProbability) * 100)%
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

@code {
  private ServerSettingsModel editModel = new();
  private ApiResilience.Server.ServerSettings currentSettings = new();
  private string statusMessage = string.Empty;
  private bool isSuccess = false;

  protected override void OnInitialized()
  {
    LoadCurrentSettings();
  }

  private void LoadCurrentSettings()
  {
    currentSettings = SettingsService.GetRuntimeSettings();
    editModel = new ServerSettingsModel
    {
      DelayProbability = currentSettings.DelayProbability,
      DelayDurationMs = currentSettings.DelayDurationMs,
      ErrorProbability = currentSettings.ErrorProbability
    };
  }

  private void HandleValidSubmit()
  {
    try
    {
      var newSettings = new ApiResilience.Server.ServerSettings
      {
        DelayProbability = editModel.DelayProbability,
        DelayDurationMs = editModel.DelayDurationMs,
        ErrorProbability = editModel.ErrorProbability
      };

      SettingsService.UpdateSettings(newSettings);
      currentSettings = SettingsService.GetRuntimeSettings();

      statusMessage = "Settings updated successfully!";
      isSuccess = true;
    }
    catch (Exception ex)
    {
      statusMessage = $"Error updating settings: {ex.Message}";
      isSuccess = false;
    }
  }

  private void ResetToDefaults()
  {
    editModel = new ServerSettingsModel
    {
      DelayProbability = 0.2,
      DelayDurationMs = 5_000,
      ErrorProbability = 0.2
    };
    statusMessage = "Form reset to default values. Click 'Apply Settings' to save.";
    isSuccess = false;
  }

  [CombinedProbabilityValidation]
  private class ServerSettingsModel
  {
    [Range(0.0, 1.0, ErrorMessage = "DelayProbability must be between 0.0 and 1.0")]
    public double DelayProbability { get; set; } = 0.2;

    [Range(0, 30_000, ErrorMessage = "DelayDurationMs must be between 0 and 30000")]
    public int DelayDurationMs { get; set; } = 5_000;

    [Range(0.0, 1.0, ErrorMessage = "ErrorProbability must be between 0.0 and 1.0")]
    public double ErrorProbability { get; set; } = 0.2;
  }
}